#include <stdio.h>
#include <stdlib.h>

/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 200 Hz

* 0 Hz - 15 Hz
  gain = 1
  desired ripple = 0.5 dB
  actual ripple = 0.3639557814680703 dB

* 16 Hz - 100 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -40.18654081423216 dB

*/

#define FILTER_TAP_NUM 347

//char parent_folder[200] = "D:\\GoogleDriveAlvin\\MyResearchGroup\\SupineStandingPulserate\\Standing\\";  //using on windows platform
char parent_folder[200] = "//media//nomad2805//LENOVO//GoogleDriveAlvin//MyResearchGroup//SupineStandingECG//Standing//"; //using linux platform

static double filter_taps[FILTER_TAP_NUM] = {
  0.005559243514455902,
  0.0012940829629474243,
  0.0011457785887122214,
  0.0008034814982179452,
  0.0003147008778014496,
  -0.0002412334167578198,
  -0.0007667684967312397,
  -0.001170832706724567,
  -0.0013827792346637943,
  -0.0013709910226764367,
  -0.0011486031959601281,
  -0.000773213142900219,
  -0.00033367654012612176,
  0.00006796781149831646,
  0.000339760072785842,
  0.00041957308271105655,
  0.000289941829048712,
  -0.000017922728180067014,
  -0.0004301202409693112,
  -0.000846968341685666,
  -0.0011654998250619291,
  -0.0013038606407144533,
  -0.0012207849695205842,
  -0.0009266070638401919,
  -0.0004819694161326008,
  0.000014836288072203927,
  0.0004500601946141024,
  0.0007207081965789586,
  0.0007594336224763432,
  0.0005515056901446217,
  0.0001401203707581042,
  -0.0003820050639329873,
  -0.0008928112835051827,
  -0.0012688813278441005,
  -0.001414483102795349,
  -0.0012851909619451447,
  -0.0009001129629291202,
  -0.0003396477245350458,
  0.0002714844859904695,
  0.0007922095525618168,
  0.0010979502419023552,
  0.001110625146212392,
  0.000818692690182253,
  0.0002820761934557826,
  -0.0003795743904753564,
  -0.0010130851408432927,
  -0.001466753763520881,
  -0.0016261707180521474,
  -0.0014424544687902776,
  -0.000945962032710336,
  -0.00024184451101711058,
  0.0005122339684606316,
  0.0011414044518982878,
  0.001494188993968387,
  0.0014789045635702123,
  0.0010874097610251942,
  0.00039987194943624284,
  -0.0004309762455598191,
  -0.0012133834536407334,
  -0.0017603545344037133,
  -0.0019340733535691892,
  -0.0016800032272097653,
  -0.0010427131817027676,
  -0.0001586186734590904,
  0.0007729087018774422,
  0.001534673517675795,
  0.0019421207883733949,
  0.0018880917159999227,
  0.0013703179217280145,
  0.0004956364110153036,
  -0.0005418739956989774,
  -0.0015031712799400303,
  -0.0021590433594675875,
  -0.0023437046622253417,
  -0.0019966322546860473,
  -0.001180232584742243,
  -0.00007045049441223409,
  0.0010815157647859138,
  0.0020052204538858944,
  0.002475918286865934,
  0.0023677956463485548,
  0.0016883816885399218,
  0.0005776112338845939,
  -0.000717554191728602,
  -0.0019031394162858238,
  -0.00269170934606051,
  -0.0028780405687678823,
  -0.002399672364060657,
  -0.001360642823633498,
  0.000041683659378908097,
  0.0014686822127425742,
  0.002594004091861745,
  0.0031404095137655737,
  0.002959483494606719,
  0.002066534719148829,
  0.0006470624205050921,
  -0.0009836480936799225,
  -0.00244825024561988,
  -0.003395552605653017,
  -0.0035827714224991735,
  -0.0029374969766099547,
  -0.0015801729902360094,
  0.00019615191410095404,
  0.001988804758198686,
  0.003375634686217815,
  0.004014156784394081,
  0.003724811197126497,
  0.002539853862843198,
  0.0007036357585416863,
  -0.001376350252233168,
  -0.0032190822179628833,
  -0.004379892262007827,
  -0.004556739742801628,
  -0.003666985094241326,
  -0.0018760719409681916,
  0.00043123648969349364,
  0.0027320580059134606,
  0.0044827314973620224,
  0.0052457688419297755,
  0.004797436902214674,
  0.0031896182470741905,
  0.0007499344776177041,
  -0.001982959447889504,
  -0.0043764063665357915,
  -0.005848275706933032,
  -0.006006203615305613,
  -0.004748936580051434,
  -0.0023041213136447713,
  0.0008091569071687803,
  0.0038879669606599852,
  0.006201448304318455,
  0.007161154897883166,
  0.006466792648764496,
  0.004192126405331732,
  0.0007879891622017389,
  -0.003002740252692806,
  -0.006303099036908552,
  -0.008300259218628876,
  -0.008440058848742504,
  -0.006572681452131883,
  -0.003012699465354104,
  0.0015053194221288854,
  0.005971857290794623,
  0.009320518219917948,
  0.010673775367201623,
  0.009561287443751381,
  0.006059213006998278,
  0.0008129700510915078,
  -0.005069244765954795,
  -0.01023769552829824,
  -0.013394735913073334,
  -0.01360039425023401,
  -0.010521250023947068,
  -0.004563187958658401,
  0.003151796206928595,
  0.010971349617321281,
  0.017034731045019083,
  0.01967122401860271,
  0.017797532615471685,
  0.0112283868326685,
  0.0008298713022901062,
  -0.011531167903975754,
  -0.02324530118911095,
  -0.03139330597023212,
  -0.03327724922188632,
  -0.026956448931662172,
  -0.011680547112398193,
  0.011862522325276325,
  0.041547432892381005,
  0.07406322446658707,
  0.10539459985954777,
  0.13143376096630266,
  0.1486582574534591,
  0.15468085479064075,
  0.1486582574534591,
  0.13143376096630266,
  0.10539459985954777,
  0.07406322446658707,
  0.041547432892381005,
  0.011862522325276325,
  -0.011680547112398193,
  -0.026956448931662172,
  -0.03327724922188632,
  -0.03139330597023212,
  -0.02324530118911095,
  -0.011531167903975754,
  0.0008298713022901062,
  0.0112283868326685,
  0.017797532615471685,
  0.01967122401860271,
  0.017034731045019083,
  0.010971349617321281,
  0.003151796206928595,
  -0.004563187958658401,
  -0.010521250023947068,
  -0.01360039425023401,
  -0.013394735913073334,
  -0.01023769552829824,
  -0.005069244765954795,
  0.0008129700510915078,
  0.006059213006998278,
  0.009561287443751381,
  0.010673775367201623,
  0.009320518219917948,
  0.005971857290794623,
  0.0015053194221288854,
  -0.003012699465354104,
  -0.006572681452131883,
  -0.008440058848742504,
  -0.008300259218628876,
  -0.006303099036908552,
  -0.003002740252692806,
  0.0007879891622017389,
  0.004192126405331732,
  0.006466792648764496,
  0.007161154897883166,
  0.006201448304318455,
  0.0038879669606599852,
  0.0008091569071687803,
  -0.0023041213136447713,
  -0.004748936580051434,
  -0.006006203615305613,
  -0.005848275706933032,
  -0.0043764063665357915,
  -0.001982959447889504,
  0.0007499344776177041,
  0.0031896182470741905,
  0.004797436902214674,
  0.0052457688419297755,
  0.0044827314973620224,
  0.0027320580059134606,
  0.00043123648969349364,
  -0.0018760719409681916,
  -0.003666985094241326,
  -0.004556739742801628,
  -0.004379892262007827,
  -0.0032190822179628833,
  -0.001376350252233168,
  0.0007036357585416863,
  0.002539853862843198,
  0.003724811197126497,
  0.004014156784394081,
  0.003375634686217815,
  0.001988804758198686,
  0.00019615191410095404,
  -0.0015801729902360094,
  -0.0029374969766099547,
  -0.0035827714224991735,
  -0.003395552605653017,
  -0.00244825024561988,
  -0.0009836480936799225,
  0.0006470624205050921,
  0.002066534719148829,
  0.002959483494606719,
  0.0031404095137655737,
  0.002594004091861745,
  0.0014686822127425742,
  0.000041683659378908097,
  -0.001360642823633498,
  -0.002399672364060657,
  -0.0028780405687678823,
  -0.00269170934606051,
  -0.0019031394162858238,
  -0.000717554191728602,
  0.0005776112338845939,
  0.0016883816885399218,
  0.0023677956463485548,
  0.002475918286865934,
  0.0020052204538858944,
  0.0010815157647859138,
  -0.00007045049441223409,
  -0.001180232584742243,
  -0.0019966322546860473,
  -0.0023437046622253417,
  -0.0021590433594675875,
  -0.0015031712799400303,
  -0.0005418739956989774,
  0.0004956364110153036,
  0.0013703179217280145,
  0.0018880917159999227,
  0.0019421207883733949,
  0.001534673517675795,
  0.0007729087018774422,
  -0.0001586186734590904,
  -0.0010427131817027676,
  -0.0016800032272097653,
  -0.0019340733535691892,
  -0.0017603545344037133,
  -0.0012133834536407334,
  -0.0004309762455598191,
  0.00039987194943624284,
  0.0010874097610251942,
  0.0014789045635702123,
  0.001494188993968387,
  0.0011414044518982878,
  0.0005122339684606316,
  -0.00024184451101711058,
  -0.000945962032710336,
  -0.0014424544687902776,
  -0.0016261707180521474,
  -0.001466753763520881,
  -0.0010130851408432927,
  -0.0003795743904753564,
  0.0002820761934557826,
  0.000818692690182253,
  0.001110625146212392,
  0.0010979502419023552,
  0.0007922095525618168,
  0.0002714844859904695,
  -0.0003396477245350458,
  -0.0009001129629291202,
  -0.0012851909619451447,
  -0.001414483102795349,
  -0.0012688813278441005,
  -0.0008928112835051827,
  -0.0003820050639329873,
  0.0001401203707581042,
  0.0005515056901446217,
  0.0007594336224763432,
  0.0007207081965789586,
  0.0004500601946141024,
  0.000014836288072203927,
  -0.0004819694161326008,
  -0.0009266070638401919,
  -0.0012207849695205842,
  -0.0013038606407144533,
  -0.0011654998250619291,
  -0.000846968341685666,
  -0.0004301202409693112,
  -0.000017922728180067014,
  0.000289941829048712,
  0.00041957308271105655,
  0.000339760072785842,
  0.00006796781149831646,
  -0.00033367654012612176,
  -0.000773213142900219,
  -0.0011486031959601281,
  -0.0013709910226764367,
  -0.0013827792346637943,
  -0.001170832706724567,
  -0.0007667684967312397,
  -0.0002412334167578198,
  0.0003147008778014496,
  0.0008034814982179452,
  0.0011457785887122214,
  0.0012940829629474243,
  0.005559243514455902
};

typedef struct
{
	int indexdata;
	double maxvalue;
}argmax;

double *convolve(double *p_coeffs, int p_coeffs_n,double *p_in, int n)
{
	int i, j, k;
	double tmp;
	double *p_out;
	
	p_out = (double*)malloc(5000000*sizeof(double));

	for (k = 0; k < n; k++)  //  position in output
	{
		tmp = 0;
		for (i = 0; i < p_coeffs_n; i++)  //  position in coefficients array
		{
			j = k-i;  //  position in input
			if (j >= 0)  //  bounds check for input buffer
			{
				tmp += p_coeffs[i]*p_in[j];
			}
			else
			{
				tmp = 0;
			}
		}
		p_out[k] = tmp;
	}
	return p_out;
	free(p_out);
}

typedef struct
{
	int idx_max;
	double val_max;
	
}maxV;

maxV findmax(double *p_inp,int ndata)
{
	maxV maxvalue;
	int i;
	
	maxvalue.idx_max = 0;
	maxvalue.val_max = 0;
	
	for (i = 0; i < ndata; i++)
	{
		if (p_inp[i] > maxvalue.val_max)
		{
			maxvalue.idx_max = i;
			maxvalue.val_max = p_inp[i];
		}
	}
	return maxvalue;	
}

void detectRR(double *x, int nstart, int nend, int windows_size)
{
	int j, rr_idx;
	double vmax = 0;
	double mean, summean = 0;
	FILE* file_temuan;
	FILE* file_RR_t;
	
	char S1[200], S2[200];
	double max_thres;
	
	sprintf(S1, "%sRRdetection.dat", parent_folder);
	sprintf(S2, "%sRR.dat", parent_folder);
	file_temuan = fopen(S1, "w");
	file_RR_t = fopen(S2, "w");
	
	j = 0;
	while (nstart <= nend)
	{
		summean = summean+x[nstart];
		nstart++;
		j++;
	}
	mean = summean/j;
	//mean = 700;
	printf("Mean : %lf \n", mean);
	
	j = 0;
	max_thres = mean;
	while (nstart < nend)
	{
		rr_idx = 0;
		vmax = 0;
		if (x[nstart] > mean + 20)
		{
			for (j = nstart; j < nstart+windows_size; j++)
			{
				if (x[j] > vmax)
				{
					rr_idx = j;
					vmax = x[j];
				}
				else
				{
					fprintf(file_temuan,"%d,%lf\n", rr_idx, vmax);
					fprintf(file_RR_t, "%d\n", rr_idx);
					nstart += windows_size;
					break;
				}
			}
		}
		else
		{
			nstart++;
		}
	}
	fclose(file_temuan);
	fclose(file_RR_t);
}

void calcRR()
{
	FILE* buka_RR;
	int nlength = 0, *RRint, ntotal;
	char buff[100];
	char S[200];
	
	RRint = (int *)malloc(100000*sizeof(int));
	
	sprintf(S, "%sRRdetection.dat", parent_folder);
	buka_RR = fopen("", "r");
	while (!feof(buka_RR))
	{
		fgets(buff, 100, buka_RR);
		RRint[nlength] = atoi(buff);
		nlength++;
	}
	ntotal = nlength-1;
	
	fclose(buka_RR);
	
	int i = 0;
	FILE* RR_int_time;
	
	RR_int_time = fopen(S, "w");
	for (i = 0; i < ntotal-1; i++)
	{
		fprintf(RR_int_time, "%d,%d\n", i, RRint[i+1]-RRint[i]);
	}
	fclose(RR_int_time);
}

int main(int argc, char *argv[]){
	
	FILE* file_baca; 
	FILE* file_tulis;
	double *baca_data;
	int i = 0;
	char buff[255];
	double *hasil_filter;
	double *nilaimax;
	int n_start = 10000, n_end = 110000;
	char source_folder[200];
	char S1[200], S2[200];
	
	sprintf(source_folder, "%s%s", parent_folder, argv[1]);
	file_baca = fopen(source_folder, "r");
	
	if(argc < 2)
	{
		printf("use --> run <filename> <windowsize>\n");
		exit(0);
	}
	
	if (file_baca == NULL)
	{
		printf("file not found\n");
		exit(0);
	}
	
	sprintf(S1, "%sforplot.dat", parent_folder);
	file_tulis = fopen(S1,"w");
	baca_data = (double *)malloc(5000000*sizeof(double));
	for (i = 0; i < 127757; i++){
		fgets(buff,255,file_baca);
		baca_data[i] = atof(buff);
		fprintf(file_tulis,"%d,%lf\n",i,baca_data[i]);
	}
	
	fclose(file_baca);
	fclose(file_tulis);
	
	sprintf(S2, "%shasil.dat", parent_folder); // the results of filtered signal
	file_tulis = fopen(S2,"w");	
	hasil_filter = convolve(filter_taps,FILTER_TAP_NUM,baca_data,127757);
	for (i = n_start; i <= n_end; i++){
		fprintf(file_tulis, "%d,%lf\n", i, hasil_filter[i]);
	}
	
	detectRR(hasil_filter, n_start, n_end, atof(argv[2]));
	calcRR(); //calculate the RR Interval
	
	free(baca_data);
	fclose(file_tulis);
	
	return 0;
}
